<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share : Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #000; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .video-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        video { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }
    </style>
</head>
<body class="text-white">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center p-4 z-50">
        <div class="max-w-sm w-full bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 text-center">
            <h1 class="text-2xl font-bold mb-2 text-cyan-400">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</h1>
            <p class="text-gray-400 text-xs mb-6">‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏à‡∏≤‡∏Å Host ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏°</p>

            <input type="text" id="remote-id-input" placeholder="‡∏ß‡∏≤‡∏á Connection ID ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="w-full bg-gray-900 border border-gray-600 text-white text-center text-lg font-mono rounded-lg px-4 py-3 mb-4 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition">

            <button id="btn-connect" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-105">
                üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            </button>
            <p id="status-log" class="text-xs text-red-400 mt-4 h-4"></p>

            <div id="diag-panel" class="mt-4 text-left text-xs bg-gray-900 p-3 rounded-md border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <strong class="text-sm text-cyan-300">Diagnostics</strong>
                    <div class="flex gap-2">
                        <button id="copy-diag" class="px-2 py-1 text-xs bg-gray-800 rounded">Copy logs</button>
                        <button id="show-ice" class="px-2 py-1 text-xs bg-gray-800 rounded">Show ICE</button>
                        <button id="show-net" class="px-2 py-1 text-xs bg-gray-800 rounded">Net</button>
                    </div>
                </div>
                <pre id="diag-log" class="whitespace-pre-wrap max-h-40 overflow-auto text-[12px] text-gray-300"></pre>
            </div>
        </div>
    </div>

    <!-- Video Area -->
    <div class="video-container">
        <video id="remote-video" autoplay playsinline controls></video>
    </div>

    <!-- Overlay -->
    <div id="controls-overlay" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur px-6 py-2 rounded-full hidden gap-4">
        <button onclick="toggleFullScreen()" class="hover:text-cyan-400 transition">‚õ∂ Fullscreen</button>
        <span class="text-gray-500">|</span>
        <button onclick="location.reload()" class="text-red-400 hover:text-red-300 transition">Disconnect</button>
    </div>

    <button id="play-btn" class="hidden fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-cyan-500 text-white px-4 py-2 rounded">Play</button>
    <div id="toast" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm z-50"></div>

    <script>
        const loginScreen = document.getElementById('login-screen');
        const remoteIdInput = document.getElementById('remote-id-input');
        const btnConnect = document.getElementById('btn-connect');
        const remoteVideo = document.getElementById('remote-video');
        const statusLog = document.getElementById('status-log');
        const controlsOverlay = document.getElementById('controls-overlay');

        let peer = null;

        // Init PeerJS
        // ICE servers - add TURN server here if your users are behind strict NATs/firewalls
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            // { urls: 'turn:your.turn.server:3478', username: 'user', credential: 'pass' }
        ];

        peer = new Peer(null, {
            debug: 1,
            config: { iceServers: ICE_SERVERS }
        });

        peer.on('error', (err) => {
            console.error('Peer error:', err);
            showToast('Peer error: ' + err, 'error');
            logDiag('Peer error: ' + err, 'error');
        });

        // 1. ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Host (‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
        peer.on('call', (call) => {
            console.log("Incoming call from Host...");
            logDiag('Incoming call from Host: ' + call.peer);
            statusLog.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏†‡∏≤‡∏û...";
            statusLog.className = "text-xs text-blue-400 mt-4 h-4 animate-pulse";
            
            // ‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢ (Answer)
            call.answer(); 
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
            call.on('stream', (remoteStream) => {
                console.log("Stream Received!");
                logDiag('Stream received from: ' + call.peer);
                loginScreen.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login
                controlsOverlay.classList.remove('hidden');
                controlsOverlay.style.display = 'flex';
                
                remoteVideo.srcObject = remoteStream;
                remoteVideo.play().catch(e => {
                    console.error("Autoplay blocked:", e);
                    logDiag('Autoplay blocked: ' + e, 'warn');
                    showToast('Autoplay blocked ‚Äî ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Play ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô', 'warn', 6000);
                    document.getElementById('play-btn').classList.remove('hidden');
                });
            });

            call.on('close', () => {
                showToast('Host ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß','info',2000);
                logDiag('Call closed by host: ' + call.peer);
                setTimeout(() => location.reload(), 1500);
            });
        });

        // Diagnostics utilities
        function logDiag(message, level = 'info') {
            const el = document.getElementById('diag-log');
            if (!el) return;
            const t = new Date().toLocaleTimeString();
            el.textContent = `[${t}] ${message}\n` + el.textContent;
        }

        document.getElementById('copy-diag').addEventListener('click', () => {
            const el = document.getElementById('diag-log');
            if (!el) return;
            navigator.clipboard.writeText(el.textContent || '').then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å log ‡πÅ‡∏•‡πâ‡∏ß'));
        });

        document.getElementById('show-ice').addEventListener('click', () => {
            logDiag('ICE servers: ' + JSON.stringify(ICE_SERVERS));
            showToast('‡πÅ‡∏™‡∏î‡∏á ICE servers ‡πÉ‡∏ô diagnostics');
        });

        document.getElementById('show-net').addEventListener('click', () => {
            try {
                const info = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (info) {
                    logDiag('Network: type=' + info.effectiveType + ' down=' + info.downlink + ' rtt=' + info.rtt);
                } else {
                    logDiag('Network info not available');
                }
            } catch (e) { logDiag('Error reading network info: ' + e, 'warn'); }
        });

        btnConnect.addEventListener('click', () => {
            const hostId = remoteIdInput.value.trim();
            if (!hostId) {
                statusLog.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏Ñ‡∏£‡∏±‡∏ö";
                return;
            }

            statusLog.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Host...";
            statusLog.className = "text-xs text-yellow-400 mt-4 h-4";
            btnConnect.disabled = true;
            btnConnect.classList.add('opacity-50');

            // 2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Data Connection ‡πÑ‡∏õ‡∏´‡∏≤ Host ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
            const conn = peer.connect(hostId);

            conn.on('open', () => {
                statusLog.innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠ Host ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û...";
                statusLog.className = "text-xs text-green-400 mt-4 h-4";
                showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Host ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','info');
            });

            conn.on('data', (data) => {
                if(data.msg) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Host (‡πÄ‡∏ä‡πà‡∏ô "‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...")
                    statusLog.innerText = data.msg;
                    showToast(data.msg,'info',3000);
                }
            });

            conn.on('close', () => {
                showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Host ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î','warn');
                btnConnect.disabled = false;
                btnConnect.classList.remove('opacity-50');
            });
            
            conn.on('error', (err) => {
                console.error(err);
                statusLog.innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (ID ‡∏ú‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠ Host ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)";
                statusLog.className = "text-xs text-red-400 mt-4 h-4";
                btnConnect.disabled = false;
                btnConnect.classList.remove('opacity-50');
                showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (ID ‡∏ú‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠ Host ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)','error');
            });
        });

        // Play button (autoplay fallback)
        document.getElementById('play-btn').addEventListener('click', () => {
            remoteVideo.play().then(() => {
                document.getElementById('play-btn').classList.add('hidden');
            }).catch(e => console.error('Play failed:', e));
        });

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // Simple toast utility
        function showToast(message, type = 'info', timeout = 3500) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg text-sm z-50';
            const bg = type === 'error' ? 'bg-red-600' : type === 'warn' ? 'bg-yellow-600' : 'bg-gray-800';
            toast.classList.add(bg);
            toast.innerText = message;
            toast.classList.remove('hidden');
            clearTimeout(toast._hideTimeout);
            toast._hideTimeout = setTimeout(() => toast.classList.add('hidden'), timeout);
        }
    </script>
</body>
</html>
