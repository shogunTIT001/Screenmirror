<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share : Host</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div class="max-w-md w-full bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 text-center">
        <h1 class="text-3xl font-bold mb-2 text-cyan-400">Screen Share Host</h1>
        <p class="text-gray-400 text-sm mb-6">‡∏ù‡∏±‡πà‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå)</p>

        <!-- ID Display -->
        <div id="connection-status" class="mb-6 p-4 bg-gray-900 rounded-xl border border-dashed border-gray-600">
            <p class="text-xs text-gray-500 uppercase font-bold mb-1">Your Connection ID</p>
            <div id="my-id" class="text-2xl font-mono text-yellow-400 font-bold tracking-wider select-all cursor-pointer" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">
                Waiting...
            </div>
            <p class="text-[10px] text-gray-500 mt-2">‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (Viewer)</p>
            <div class="mt-3 text-left text-xs">
                <label class="inline-flex items-center gap-2 text-gray-300">
                    <input id="announce-checkbox" type="checkbox" class="w-4 h-4" />
                    ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ (Discoverable)
                </label>
                <div id="announce-status" class="text-[10px] text-gray-500 mt-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>
            </div>
        </div>

        <!-- Controls -->
        <button id="btn-share" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-105 flex items-center justify-center gap-2 mb-4">
            <span>üì∫</span> 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏Å‡∏î‡∏Å‡πà‡∏≠‡∏ô)
        </button>

        <p id="status-msg" class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
        <p id="viewer-count" class="text-xs text-green-400 mt-2 hidden">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏°: 0 ‡∏Ñ‡∏ô</p>
        <div id="toast" class="mt-3 hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm z-50"></div>

        <div id="diag-panel" class="mt-4 text-left text-xs bg-gray-900 p-3 rounded-md border border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <strong class="text-sm text-cyan-300">Diagnostics</strong>
                <div class="flex gap-2">
                    <button id="copy-diag" class="px-2 py-1 text-xs bg-gray-800 rounded">Copy logs</button>
                    <button id="show-ice" class="px-2 py-1 text-xs bg-gray-800 rounded">Show ICE</button>
                </div>
            </div>
            <pre id="diag-log" class="whitespace-pre-wrap max-h-40 overflow-auto text-[12px] text-gray-300"></pre>
        </div>
    </div>

    <!-- Preview Video -->
    <div class="mt-8 w-full max-w-4xl border border-gray-700 rounded-xl overflow-hidden bg-black shadow-2xl relative group">
        <div class="absolute top-2 left-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded shadow z-10 hidden" id="live-badge">LIVE</div>
        <video id="local-video" class="w-full h-auto" autoplay muted playsinline></video>
        <div class="absolute inset-0 flex items-center justify-center text-gray-600 text-sm pointer-events-none" id="preview-placeholder">
            Preview Area
        </div>
    </div>

    <script>
        const myIdEl = document.getElementById('my-id');
        const btnShare = document.getElementById('btn-share');
        const localVideo = document.getElementById('local-video');
        const statusMsg = document.getElementById('status-msg');
        const liveBadge = document.getElementById('live-badge');
        const placeholder = document.getElementById('preview-placeholder');
        const viewerCountEl = document.getElementById('viewer-count');

        let peer = null;
        let localStream = null;
        let viewers = []; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ICE servers - ‡πÄ‡∏û‡∏¥‡πà‡∏° TURN server ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á TURN (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ TURN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î):
            // { urls: 'turn:your.turn.server:3478', username: 'user', credential: 'pass' }
        ];
        let viewersMap = {}; // map viewerId -> DataConnection (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)

        // Discovery server (change if hosted elsewhere)
        const DISCOVERY_URL = 'http://localhost:3000';

        // Try to collect local IP addresses (may be limited by browser privacy features)
        async function getLocalIPs() {
            const ips = new Set();
            try {
                const pc = new RTCPeerConnection({ iceServers: [] });
                pc.createDataChannel('');
                pc.onicecandidate = (e) => {
                    if (!e.candidate) return;
                    const s = e.candidate.candidate;
                    const m = s.match(/(?:[0-9]{1,3}\.){3}[0-9]{1,3}/g);
                    if (m) m.forEach(ip => ips.add(ip));
                };
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                // wait briefly for candidates
                await new Promise(r => setTimeout(r, 700));
                pc.close();
            } catch (e) {
                console.warn('Failed to gather local IPs', e);
            }
            return Array.from(ips);
        }

        // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô PeerJS
        function initPeer() {
            peer = new Peer(null, {
                debug: 1,
                config: {
                    iceServers: ICE_SERVERS
                }
            });

            peer.on('open', (id) => {
                myIdEl.innerText = id;
                myIdEl.classList.remove('text-gray-500');
                myIdEl.classList.add('text-yellow-400');
                showToast('Ready. ‡∏™‡πà‡∏á ID ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                logDiag('Peer open: ' + id);
            });

            // ‡∏£‡∏≠ Viewer ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (Handshake)
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    console.log("New viewer connected:", conn.peer);
                    logDiag('New viewer connected: ' + conn.peer);
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö conn ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                    viewersMap[conn.peer] = conn;

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                    if (!viewers.includes(conn.peer)) {
                        viewers.push(conn.peer);
                        updateViewerCount();
                    }

                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß -> ‡πÇ‡∏ó‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡πÄ‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    if (localStream) {
                        callViewer(conn.peer);
                        conn.send({ msg: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì..." });
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ä‡∏£‡πå -> ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏≤‡∏£‡∏≠
                        conn.send({ msg: "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠ Host ‡∏Å‡∏î‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠..." });
                        statusMsg.innerText = `‡∏°‡∏µ‡∏Ñ‡∏ô‡∏°‡∏≤‡∏£‡∏≠‡∏ä‡∏° ${viewers.length} ‡∏Ñ‡∏ô (‡∏Å‡∏î‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°)`;
                    }
                });

                conn.on('close', () => {
                    console.log('Viewer connection closed', conn.peer);
                    logDiag('Viewer connection closed: ' + conn.peer, 'warn');
                    delete viewersMap[conn.peer];
                    viewers = viewers.filter(id => id !== conn.peer);
                    updateViewerCount();
                    showToast(`‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏° ${conn.peer} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠`,'warn');
                });

                conn.on('error', (err) => {
                    console.error('Connection error with', conn.peer, err);
                    showToast(`Connection error: ${err}`,'error');
                });
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                showToast('Peer error: ' + err, 'error');
            });

            peer.on('disconnected', () => {
                showToast('Peer disconnected. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...','warn');
            });

            peer.on('close', () => {
                showToast('Peer closed','warn');
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏ó‡∏£‡∏Å‡∏•‡∏±‡∏ö (Call Back) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á Stream
        function callViewer(viewerId) {
            console.log("Calling viewer:", viewerId);
            // PeerJS Call: (ReceiverID, Stream)
            const call = peer.call(viewerId, localStream);
            
            call.on('close', () => {
                console.log("Viewer disconnected");
                logDiag('Call closed for: ' + viewerId);
                viewers = viewers.filter(id => id !== viewerId);
                updateViewerCount();
            });

            call.on('error', (err) => {
                console.error('Call error to', viewerId, err);
                logDiag('Call error to ' + viewerId + ': ' + err, 'error');
                showToast('Error sending stream to ' + viewerId,'error');
            });
        }

        function updateViewerCount() {
            viewerCountEl.innerText = `‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏°: ${viewers.length} ‡∏Ñ‡∏ô`;
            viewerCountEl.classList.remove('hidden');
        }

        // Simple toast utility (non-blocking notifications)
        function showToast(message, type = 'info', timeout = 3500) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.className = 'mt-3 fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg text-sm z-50';
            const bg = type === 'error' ? 'bg-red-600' : type === 'warn' ? 'bg-yellow-600' : 'bg-gray-800';
            toast.classList.add(bg);
            toast.innerText = message;
            toast.classList.remove('hidden');
            clearTimeout(toast._hideTimeout);
            toast._hideTimeout = setTimeout(() => toast.classList.add('hidden'), timeout);
        }

        // Diagnostics logging
        function logDiag(message, level = 'info') {
            const el = document.getElementById('diag-log');
            if (!el) return;
            const t = new Date().toLocaleTimeString();
            el.textContent = `[${t}] ${message}\n` + el.textContent;
        }

        document.getElementById('copy-diag').addEventListener('click', () => {
            const el = document.getElementById('diag-log');
            if (!el) return;
            navigator.clipboard.writeText(el.textContent || '').then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å log ‡πÅ‡∏•‡πâ‡∏ß'));
        });

        document.getElementById('show-ice').addEventListener('click', () => {
            logDiag('ICE servers: ' + JSON.stringify(ICE_SERVERS));
            showToast('‡πÅ‡∏™‡∏î‡∏á ICE servers ‡πÉ‡∏ô diagnostics');
        });

        // 2. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        btnShare.addEventListener('click', async () => {
            try {
                // ‡∏Ç‡∏≠ Capture Screen
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: true 
                });

                // ‡πÅ‡∏™‡∏î‡∏á Preview
                localVideo.srcObject = localStream;
                placeholder.classList.add('hidden');
                liveBadge.classList.remove('hidden');
                statusMsg.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏™‡∏î...";
                statusMsg.className = "text-xs text-green-400 animate-pulse";
                
                btnShare.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå...";
                btnShare.disabled = true;
                btnShare.classList.add('opacity-50', 'cursor-not-allowed');

                // ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô List
                viewers.forEach(id => callViewer(id));
                logDiag('Started sharing. Called ' + viewers.length + ' viewers.');

                // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Stop Sharing ‡∏ó‡∏µ‡πà Browser
                localStream.getVideoTracks()[0].onended = () => {
                    logDiag('Screen sharing stopped by user');
                    showToast('‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏á','info', 2000);
                    setTimeout(() => location.reload(), 1600);
                };

            } catch (err) {
                console.error("Error:", err);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ: ' + err.message,'error', 5000);
            }
        });

        // Copy ID
        myIdEl.addEventListener('click', () => {
            const text = myIdEl.innerText;
            if (text !== 'Waiting...') {
                navigator.clipboard.writeText(text).then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡πÅ‡∏•‡πâ‡∏ß!','info'));
            }
        });

        initPeer();
    </script>
</body>
</html>